{% extends "base.html" %}
{% load static %}

{% block scripts %}
{{ block.super }}
<script>

</script>
{% endblock %}

{% block body %}

{% include "navbar.html" %}

<!-- <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script> -->
<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=l7xxcf22dfc606b84851aa80fef36db0a258"></script>
<script type="text/javascript">
    AOS.init();
    var map;
    var markerInfo;
    //출발지,도착지 마커
    var marker_s, marker_e, marker_p, marker_on, marker_off;
    //경로그림정보
    let resultdrawArr = [];

    var latitude;
    var longitude;

    function initTmap() {
        // 1. 지도 띄우기
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(37.39725123, 126.95650002),
            width: "500px",
            height: "400px",
            zoom: 15,
            zoomControl: true,
            scrollwheel: true,
            marginLeft: "100px",

        });
        marker_s = new Tmapv2.Marker(
            {
                position: new Tmapv2.LatLng(37.39725123,
                    126.95650002),
                icon: "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png",
                iconSize: new Tmapv2.Size(24, 38),
                map: map
            });
        marker_on = new Tmapv2.Marker(
            {
                position: new Tmapv2.LatLng(37.39425171,
                    126.96377722),
                icon: "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_o.png",
                iconSize: new Tmapv2.Size(24, 38),
                map: map
            });
        marker_off = new Tmapv2.Marker(
            {
                position: new Tmapv2.LatLng(37.49304858,
                    127.11823260),
                icon: "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_f.png",
                iconSize: new Tmapv2.Size(24, 38),
                map: map
            });
        // 3. 경로탐색 API 사용요청

        function getRoute(start, end) {
            return {
                method: 'POST',
                headers: {
                    accept: 'application/json',
                    'content-type': 'application/json',
                    appKey: 'l7xxcf22dfc606b84851aa80fef36db0a258'
                },
                body: JSON.stringify({
                    startX: start.lon,
                    startY: start.lat,
                    endX: end.lon,
                    endY: end.lat,
                    startName: start.name,
                    endName: end.name
                })

            }

        }

        function getUserRoute(path) {
            let url = 'https://apis.openapi.sk.com/tmap/routes/';
        }

        const options1 = {
            method: 'POST',
            headers: {
                accept: 'application/json',
                'content-type': 'application/json',
                appKey: 'l7xxcf22dfc606b84851aa80fef36db0a258'
            },
            body: JSON.stringify({
                startX: 126.95650002,
                startY: 37.39725123,
                endX: 126.96377722,
                endY: 37.39425171,
                startName: '한가람신라아파트',
                endName: '평촌역4호선'
            })
        };

        fetch('https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1&callback=function', options1)
            .then(response => response.json())
            .then((response) => {
                let resultData = response.features;
                setLoute(resultData, "#0008ff");
            })
            .catch(err => console.error(err));


        const options2 = {
            method: 'POST',
            headers: {
                accept: 'application/json',
                'content-type': 'application/json',
                appKey: 'l7xxcf22dfc606b84851aa80fef36db0a258'
            },
            body: JSON.stringify({
                endX: 127.11823260,
                endY: 37.49304858,
                startX: 126.96377722,
                startY: 37.39425171,
                startName: '평촌역',
                endName: '가락시장역'
            })
        };

        fetch('https://apis.openapi.sk.com/tmap/routes?version=1&callback=function', options2)
            .then(response => response.json())
            .then(response => {
                setLoute(response.features, "#ff0000");
            })
            .catch(err => console.error(err));
    }

    function drawLine(arrPoint, color) {
        var polyline_;

        polyline_ = new Tmapv2.Polyline({
            path: arrPoint,
            strokeColor: color,
            strokeWeight: 6,
            map: map
        });
        resultdrawArr.push(polyline_);
    }

    function setLoute(resultData, color) {
        let drawInfoArr = [];

        for (var i in resultData) { //for문 [S]
            var geometry = resultData[i].geometry;
            var properties = resultData[i].properties;
            var polyline_;

            if (geometry.type == "LineString") {
                for (var j in geometry.coordinates) {
                    // 경로들의 결과값(구간)들을 포인트 객체로 변환 
                    var latlng = new Tmapv2.LatLng(
                        geometry.coordinates[j][1],
                        geometry.coordinates[j][0]);

                    drawInfoArr.push(latlng);
                }
            } else {
                var markerImg = "";
                var pType = "";
                var size;

                markerImg = "http://topopen.tmap.co.kr/imgs/point.png";
                pType = "GP";
                size = new Tmapv2.Size(8, 8);

                // 경로들의 결과값들을 포인트 객체로 변환 
                var latlon = new Tmapv2.Point(
                    geometry.coordinates[0],
                    geometry.coordinates[1]);

                var routeInfoObj = {
                    markerImage: markerImg,
                    lng: latlon.x,
                    lat: latlon.y,
                    pointType: pType
                };

                // Marker 추가

            }
        }
        drawLine(drawInfoArr, color);

        document.querySelector("#btn_select").addEventListener('click', (event) => {
        let data = JSON.parse('{{pointInfoList|escapejs}}');
        console.log(data);
    });
    }

    
</script>
</head>

<style>
    .map_wrap {
        display: flex;
        justify-content: center;
        padding-top: 50px;
        background-color: #FAFAFA;
    }
</style>
<section id="breadcrumbs" class="breadcrumbs">
    <div class="container">

        <div class="d-flex justify-content-between align-items-center">

            <body onload="initTmap();">

                <div class="ft_area">
                    <div class="ft_select_wrap">
                        <div class="ft_select">
                            <select id="selectLevel">
                                <option value="0" selected="selected">교통최적+추천</option>
                                <option value="1">교통최적+무료우선</option>
                                <option value="2">교통최적+최소시간</option>
                                <option value="3">교통최적+초보</option>
                                <option value="4">교통최적+고속도로우선</option>
                                <option value="10">최단거리+유/무료</option>
                                <option value="12">이륜차도로우선</option>
                                <option value="19">교통최적+어린이보호구역 회피</option>
                            </select> <select id="year">
                                <option value="N" selected="selected">교통정보 표출 옵션</option>
                                <option value="Y">Y</option>
                                <option value="N">N</option>
                            </select>
                            <button id="btn_select">적용하기</button>
                            <a id="userlink" href="/userRoute">User route</a>
                            <a href="/driverRoute">Driver route</a>
                        </div>
                    </div>
                </div>
            </body>
</section>

<div class="map_act_btn_wrap clear_box"></div>
<div class="clear"></div>
</div>

<div id="map_wrap" class="map_wrap">
    <div id="map_div"></div>
</div>

{% for location in location_list %}
<span class="location_txt"> {{ location.altitude }} </span>
{% endfor %}

<div class="map_act_btn_wrap clear_box"></div>
<p id="result"></p>
<br />

{% include "footer.html" %}

{% endblock %}